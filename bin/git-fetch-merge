#!/usr/bin/env fish
#
# Fetches and rebases (or merges) a branch from upstream (or origin).
# Tries rebase first, falls back to merge if rebase fails.
#
# $1 - Branch name (required)
#
# Examples
#
#   git fetch-merge main
#   git fetch-merge develop

if contains -- --help $argv; or contains -- -h $argv
    echo "Usage: git fetch-merge <branch>"
    echo ""
    echo "Fetches a branch from upstream (or origin) and tries to rebase onto it."
    echo "Falls back to merge if rebase encounters conflicts."
    echo ""
    echo "Arguments:"
    echo "  branch   Branch to fetch and rebase/merge (required)"
    echo ""
    echo "Examples:"
    echo "  git fetch-merge main      # Fetch and rebase onto main branch"
    echo "  git fetch-merge develop   # Fetch and rebase onto develop branch"
    exit 0
end

if test (count $argv) -eq 0
    echo "Error: Branch name is required" >&2
    echo "Run 'git fetch-merge --help' for usage information" >&2
    exit 1
end

set remote (git remote | grep upstream)
set branch $argv[1]

if test -z $remote
	set remote origin
end

echo (set_color --bold magenta) "-> Fetching $remote/$branch..." (set_color normal)
	and git fetch $remote
	and begin
		echo (set_color --bold magenta) "-> Attempting rebase onto $remote/$branch..." (set_color normal)
		if git rebase $remote/$branch
			echo (set_color green) "-> Successfully rebased onto $remote/$branch" (set_color normal)
		else
			echo (set_color yellow) "-> Rebase failed, falling back to merge..." (set_color normal)
			and git rebase --abort 2>/dev/null
			and echo (set_color --bold magenta) "-> Merging $remote/$branch..." (set_color normal)
			and git merge $remote/$branch
			and echo (set_color green) "-> Successfully merged $remote/$branch" (set_color normal)
		end
	end
